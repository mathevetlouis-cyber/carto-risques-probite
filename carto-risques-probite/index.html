<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartographie des Risques - Version Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }

        header {
            background: linear-gradient(135deg, #0056b3 0%, #007bff 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }

        header p {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            margin: 20px auto;
            width: 95%;
            max-width: 1400px;
        }

        /* Syst√®me d'onglets */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 0;
            background: white;
            padding: 10px 10px 0 10px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-button {
            padding: 12px 24px;
            background: #e9ecef;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #dee2e6;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Formulaires */
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Combo Select + Textarea */
        .combo-input {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .combo-input select {
            width: 200px;
            flex-shrink: 0;
        }

        .combo-input textarea {
            flex: 1;
            min-height: 60px;
        }

        /* Checkboxes am√©lior√©es */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-label:hover {
            background: #e7f3ff;
        }

        .checkbox-label input {
            margin-right: 8px;
            cursor: pointer;
        }

        /* Boutons */
        button {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 12px 10px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, #0056b3 0%, #007bff 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover {
            background: #0056b3;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e7f3ff;
        }

        .low {
            background-color: #d4edda !important;
        }

        .medium {
            background-color: #fff3cd !important;
        }

        .high {
            background-color: #f8d7da !important;
        }

        /* Matrice de criticit√© */
        .risk-matrix {
            display: grid;
            grid-template-columns: 50px repeat(5, 1fr);
            grid-template-rows: 50px repeat(5, 1fr);
            gap: 2px;
            max-width: 800px;
            margin: 20px auto;
            background: #dee2e6;
        }

        .matrix-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: #f8f9fa;
            padding: 10px;
        }

        .matrix-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .matrix-cell:hover {
            transform: scale(1.05);
            z-index: 5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .matrix-cell.risk-low {
            background-color: #28a745;
            color: white;
        }

        .matrix-cell.risk-medium {
            background-color: #ffc107;
            color: #212529;
        }

        .matrix-cell.risk-high {
            background-color: #dc3545;
            color: white;
        }

        .risk-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Statistiques */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #007bff;
            margin: 10px 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        /* L√©gende */
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
        }

        /* Footer */
        .footer {
            text-align: center;
            font-size: 11px;
            padding: 20px;
            background-color: #f8f9fa;
            color: #6c757d;
            margin-top: 40px;
            border-top: 1px solid #dee2e6;
        }

        /* Messages */
        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Responsive */
        @media screen and (max-width: 768px) {
            .container {
                width: 100%;
                padding: 10px;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .combo-input {
                flex-direction: column;
            }

            .combo-input select {
                width: 100%;
            }

            .risk-matrix {
                font-size: 14px;
            }

            .matrix-cell {
                min-height: 60px;
                font-size: 14px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .filter-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 5px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>üõ°Ô∏è Cartographie des Risques d'Atteintes √† la Probit√©</h1>
        <p>Outil professionnel de gestion et d'analyse des risques</p>
    </header>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- S√©lecteur de Cartographie -->
        <div style="background: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 300px;">
                <label style="font-weight: 600; color: #495057; white-space: nowrap;">üìÇ Cartographie :</label>
                <select id="projectSelector" onchange="switchProject()" style="flex: 1; min-width: 200px;">
                    <!-- Options g√©n√©r√©es dynamiquement -->
                </select>
            </div>
            <div class="btn-group">
                <button onclick="showNewProjectDialog()" class="btn-success" style="padding: 8px 16px;">‚ûï Nouvelle</button>
                <button onclick="showRenameProjectDialog()" class="btn-info" style="padding: 8px 16px;">‚úèÔ∏è Renommer</button>
                <button onclick="duplicateProject()" class="btn-warning" style="padding: 8px 16px;">üìã Dupliquer</button>
                <button onclick="deleteProject()" class="btn-danger" style="padding: 8px 16px;">üóëÔ∏è Supprimer</button>
            </div>
        </div>

        <!-- Syst√®me d'onglets -->
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('tableau')">üìã Tableau des Risques</button>
            <button class="tab-button" onclick="openTab('ajout')">‚ûï Ajouter un Risque</button>
            <button class="tab-button" onclick="openTab('visualisation')">üìà Visualisation</button>
            <button class="tab-button" onclick="openTab('statistiques')">üìâ Statistiques</button>
            <button class="tab-button" onclick="openTab('parametres')">‚öôÔ∏è Param√®tres</button>
        </div>

        <!-- ONGLET TABLEAU DES RISQUES -->
        <div id="tableau" class="tab-content active">
            <h2 class="section-title">Tableau des Risques</h2>

            <!-- Filtres -->
            <div class="filter-bar">
                <div class="filter-row">
                    <div class="form-group">
                        <label for="filterProcess">Filtrer par processus</label>
                        <select id="filterProcess" onchange="filterRisks()">
                            <option value="">Tous les processus</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterCriticity">Filtrer par criticit√©</label>
                        <select id="filterCriticity" onchange="filterRisks()">
                            <option value="">Toutes les criticit√©s</option>
                            <option value="low">Faible (1-4)</option>
                            <option value="medium">Moyenne (5-12)</option>
                            <option value="high">√âlev√©e (15-25)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchRisk">Rechercher</label>
                        <input type="text" id="searchRisk" placeholder="Rechercher dans les sc√©narios..." oninput="filterRisks()">
                    </div>
                </div>
            </div>

            <!-- Tableau des risques -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('process')">Processus ‚Üï</th>
                            <th>Sc√©nario</th>
                            <th>Type de Risque</th>
                            <th onclick="sortTable('probability')">Occur. ‚Üï</th>
                            <th onclick="sortTable('impact')">Grav. ‚Üï</th>
                            <th onclick="sortTable('criticity')">Risque Brut ‚Üï</th>
                            <th>Moyens Org.</th>
                            <th>Moyens Hum.</th>
                            <th>Moyens Tech.</th>
                            <th onclick="sortTable('netRisk')">Risque Net ‚Üï</th>
                            <th>Actions</th>
                            <th onclick="sortTable('updateHistory')">Mis √† jour ‚Üï</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="riskTable">
                        <!-- Lignes g√©n√©r√©es dynamiquement -->
                    </tbody>
                </table>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button onclick="exportToPDF()" class="btn-danger">üìÑ T√©l√©charger en PDF</button>
                <button onclick="exportToDoc()" class="btn-info">üìù T√©l√©charger en DOC</button>
                <button onclick="exportToJSON()" class="btn-success">üíæ Exporter les donn√©es (JSON)</button>
                <button onclick="document.getElementById('importJSON').click()" class="btn-warning">üì• Importer des donn√©es (JSON)</button>
                <input type="file" id="importJSON" accept=".json" style="display: none;" onchange="importFromJSON(event)">
            </div>
        </div>

        <!-- ONGLET AJOUTER UN RISQUE -->
        <div id="ajout" class="tab-content">
            <h2 class="section-title">Ajouter un Risque</h2>

            <div class="form-section">
                <h3>Formulaire de Saisie</h3>
                <form id="riskForm" onsubmit="event.preventDefault(); addRisk();">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="process">Processus *</label>
                            <select id="process" required>
                                <option value="">-- S√©lectionner --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="probability">Probabilit√© / Occurrence *</label>
                            <select id="probability" required>
                                <option value="1">1 - Tr√®s rare</option>
                                <option value="2">2 - Rare</option>
                                <option value="3">3 - Possible</option>
                                <option value="4">4 - Probable</option>
                                <option value="5">5 - Tr√®s probable</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact">Gravit√© / Impact *</label>
                            <select id="impact" required>
                                <option value="1">1 - N√©gligeable</option>
                                <option value="2">2 - Faible</option>
                                <option value="3">3 - Mod√©r√©</option>
                                <option value="4">4 - Grave</option>
                                <option value="5">5 - Critique</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scenario">Sc√©nario de risque *</label>
                        <textarea id="scenario" required placeholder="D√©crivez le sc√©nario de risque..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Type de risque / Responsabilit√© (s√©lectionnez un ou plusieurs) *</label>
                        <div class="checkbox-grid" id="riskTypeContainer">
                            <!-- Checkboxes g√©n√©r√©es dynamiquement -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mitigationOrg">Moyens de ma√Ætrise - Organisationnel</label>
                        <div class="combo-input">
                            <select id="mitigationOrgSelect" onchange="insertSuggestion('mitigationOrg', this.value); this.value='';">
                                <option value="">-- Suggestions --</option>
                            </select>
                            <textarea id="mitigationOrg" placeholder="S√©lectionnez une suggestion ou saisissez vos propres mesures..."></textarea>
                        </div>
                        <div class="help-text">S√©lectionnez une suggestion dans la liste ou saisissez librement vos mesures</div>
                    </div>

                    <div class="form-group">
                        <label for="mitigationHum">Moyens de ma√Ætrise - Humain</label>
                        <div class="combo-input">
                            <select id="mitigationHumSelect" onchange="insertSuggestion('mitigationHum', this.value); this.value='';">
                                <option value="">-- Suggestions --</option>
                            </select>
                            <textarea id="mitigationHum" placeholder="S√©lectionnez une suggestion ou saisissez vos propres mesures..."></textarea>
                        </div>
                        <div class="help-text">S√©lectionnez une suggestion dans la liste ou saisissez librement vos mesures</div>
                    </div>

                    <div class="form-group">
                        <label for="mitigationTech">Moyens de ma√Ætrise - Technique</label>
                        <div class="combo-input">
                            <select id="mitigationTechSelect" onchange="insertSuggestion('mitigationTech', this.value); this.value='';">
                                <option value="">-- Suggestions --</option>
                            </select>
                            <textarea id="mitigationTech" placeholder="S√©lectionnez une suggestion ou saisissez vos propres mesures..."></textarea>
                        </div>
                        <div class="help-text">S√©lectionnez une suggestion dans la liste ou saisissez librement vos mesures</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="netRisk">Risque Net / Cotation du risque r√©siduel (apr√®s ma√Ætrise) *</label>
                            <select id="netRisk" required>
                                <option value="1">1 - Tr√®s faible</option>
                                <option value="2">2 - Faible</option>
                                <option value="3">3 - Mod√©r√©</option>
                                <option value="4">4 - √âlev√©</option>
                                <option value="5">5 - Tr√®s √©lev√©</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="actions">Moyens de pr√©vention √† mettre en place / Actions</label>
                        <textarea id="actions" placeholder="Actions pr√©ventives/correctives √† engager..."></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn-primary">‚ûï Ajouter le risque</button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ONGLET VISUALISATION -->
        <div id="visualisation" class="tab-content">
            <h2 class="section-title">Matrice de Criticit√©</h2>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #28a745;"></div>
                    <span>Risque Faible (1-4)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffc107;"></div>
                    <span>Risque Moyen (5-12)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #dc3545;"></div>
                    <span>Risque √âlev√© (15-25)</span>
                </div>
            </div>

            <div class="risk-matrix" id="riskMatrix">
                <!-- Matrice g√©n√©r√©e dynamiquement -->
            </div>

            <div id="matrixDetails" style="margin-top: 30px;">
                <h3 class="section-title">Risques s√©lectionn√©s</h3>
                <div id="matrixRisksList"></div>
            </div>
        </div>

        <!-- ONGLET STATISTIQUES -->
        <div id="statistiques" class="tab-content">
            <h2 class="section-title">Tableau de Bord et Statistiques</h2>

            <div class="stats-container" id="statsContainer">
                <!-- Statistiques g√©n√©r√©es dynamiquement -->
            </div>

            <div style="margin-top: 30px;">
                <h3 class="section-title">R√©partition par Processus</h3>
                <div id="processStats"></div>
            </div>

            <div style="margin-top: 30px;">
                <h3 class="section-title">R√©partition par Type de Risque</h3>
                <div id="typeStats"></div>
            </div>
        </div>

        <!-- ONGLET PARAM√àTRES -->
        <div id="parametres" class="tab-content">
            <h2 class="section-title">Param√®tres</h2>

            <!-- Gestion des Processus -->
            <div class="form-section">
                <h3>Gestion des Processus</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">Personnalisez la liste des processus disponibles dans vos cartographies.</p>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label for="newProcess">Nouveau processus</label>
                        <input type="text" id="newProcess" placeholder="Ex: Gestion des subventions">
                    </div>
                    <div class="form-group" style="flex: 1; justify-content: flex-end;">
                        <label>&nbsp;</label>
                        <button onclick="addProcess()" class="btn-success">‚ûï Ajouter</button>
                    </div>
                </div>

                <h4>Processus actifs :</h4>
                <div id="processList"></div>
            </div>

            <!-- Gestion des Types de Risques -->
            <div class="form-section">
                <h3>Gestion des Types de Risques</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">Personnalisez les types de risques / responsabilit√©s disponibles.</p>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label for="newRiskType">Nouveau type de risque</label>
                        <input type="text" id="newRiskType" placeholder="Ex: Manquement √† la probit√©">
                    </div>
                    <div class="form-group" style="flex: 1; justify-content: flex-end;">
                        <label>&nbsp;</label>
                        <button onclick="addRiskType()" class="btn-success">‚ûï Ajouter</button>
                    </div>
                </div>

                <h4>Types de risques actifs :</h4>
                <div id="riskTypesList"></div>
            </div>

            <!-- Gestion des Suggestions -->
            <div class="form-section">
                <h3>Suggestions pour les Moyens de Ma√Ætrise</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">Personnalisez les suggestions propos√©es pour faciliter la saisie.</p>
                
                <!-- Organisationnel -->
                <h4>Moyens Organisationnels</h4>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <input type="text" id="newOrgSuggestion" placeholder="Ex: Double v√©rification par la hi√©rarchie">
                    </div>
                    <div class="form-group" style="flex: 1; justify-content: flex-end;">
                        <button onclick="addSuggestion('org')" class="btn-success">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="orgSuggestionsList"></div>

                <!-- Humain -->
                <h4 style="margin-top: 20px;">Moyens Humains</h4>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <input type="text" id="newHumSuggestion" placeholder="Ex: Sensibilisation des agents">
                    </div>
                    <div class="form-group" style="flex: 1; justify-content: flex-end;">
                        <button onclick="addSuggestion('hum')" class="btn-success">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="humSuggestionsList"></div>

                <!-- Technique -->
                <h4 style="margin-top: 20px;">Moyens Techniques</h4>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <input type="text" id="newTechSuggestion" placeholder="Ex: Badge nominatif et suivi">
                    </div>
                    <div class="form-group" style="flex: 1; justify-content: flex-end;">
                        <button onclick="addSuggestion('tech')" class="btn-success">‚ûï Ajouter</button>
                    </div>
                </div>
                <div id="techSuggestionsList"></div>
            </div>

            <!-- Gestion des Donn√©es -->
            <div class="form-section">
                <h3>Gestion des Donn√©es</h3>
                <div class="btn-group">
                    <button onclick="clearAllRisks()" class="btn-danger">üóëÔ∏è Supprimer tous les risques</button>
                    <button onclick="resetToDefaults()" class="btn-warning">üîÑ R√©initialiser aux valeurs par d√©faut</button>
                </div>
            </div>

            <div class="form-section">
                <h3>√Ä propos</h3>
                <p><strong>Version:</strong> 2.1 Pro</p>
                <p><strong>D√©veloppeur:</strong> Louis MATHEVET-BIDINI, Pr√©sident de l'AP2DFP</p>
                <p><strong>Description:</strong> Outil professionnel de cartographie et d'analyse des risques d'atteintes √† la probit√© pour les collectivit√©s territoriales.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        Outil cr√©√© et d√©velopp√© par Louis MATHEVET-BIDINI, Pr√©sident de l'AP2DFP - Version 2.1 Pro
    </div>

    <script>
        // Variables globales
        let editIndex = null;
        let sortOrder = {};
        let currentProject = null;

        // Valeurs par d√©faut inspir√©es des cartographies r√©elles
        const defaultProcesses = [
            'Concours',
            'RH interne',
            'Missions facultatives',
            'Juridique',
            'R√©gie',
            '√âlus locaux',
            'Commande publique',
            'Gestion financi√®re et comptable',
            'Subventions',
            'Autorisations et permis',
            'Gestion du domaine public'
        ];

        const defaultRiskTypes = [
            'Corruption',
            'Favoritisme',
            'Concussion',
            'Prise ill√©gale d\'int√©r√™ts',
            'D√©tournement de fonds publics',
            'Trafic d\'influence',
            'Conflit d\'int√©r√™ts',
            'Pantouflage',
            'RGPD',
            'Autre'
        ];

        const defaultSuggestions = {
            org: [
                'Coll√©gialit√© du jury',
                'V√©rification des responsables',
                'Travail coll√©gial',
                'Double v√©rification',
                'Proc√©dure SMQ',
                'Clause pr√©alable dans les contrats',
                'Fiches de postes',
                'Liste des candidats transmise en amont',
                'Tra√ßabilit√© des clics du logiciel',
                'Restrictions d\'acc√®s des dossiers',
                'Contr√¥le sur les r√©sultats',
                'Sortie d\'inventaire',
                'Suivi des absences',
                'Grille tarifaire',
                'Renforcement des effectifs'
            ],
            hum: [
                'Sensibilisation √† la corruption',
                'Sensibilisation au d√©port',
                'Sensibilisation √† la discr√©tion professionnelle',
                'Sensibilisation aux r√®gles d√©ontologiques',
                'Sensibilisation au pantouflage',
                'V√©rification par les agents',
                'Double v√©rification op√©r√©e',
                'V√©rification coll√©giale',
                'Formation des agents',
                'Mise en place du r√©f√©rent d√©ontologue',
                'Connaissance du dispositif d\'alerte',
                'Contr√¥les demand√©s aux m√©decins',
                'Suivi des journaux de paie'
            ],
            tech: [
                'Badge nominatif et suivi des pointages',
                'Code personnel √† l\'imprimante',
                'Logiciel de recrutement',
                'Logiciel de gestion',
                'Tableau de suivi',
                'Anonymat renforc√© dans la proc√©dure',
                'M√©canisme de r√©cup√©ration du serveur',
                'Factures d√©taill√©es',
                'Grilles d\'√©valuation fines',
                'Fiches confidentielles',
                'Alarme fonctionnelle',
                'Syst√®me de tra√ßabilit√©',
                'Mise en place des cellules de signalement'
            ]
        };

        // Initialisation au chargement
        window.onload = function () {
            initializeApp();
        };

        function initializeApp() {
            if (!localStorage.getItem('projects')) {
                const defaultProject = {
                    risks: [],
                    processes: defaultProcesses,
                    riskTypes: defaultRiskTypes,
                    suggestions: defaultSuggestions
                };
                localStorage.setItem('projects', JSON.stringify({ 'Ma Cartographie': defaultProject }));
                localStorage.setItem('currentProject', 'Ma Cartographie');
            }

            currentProject = localStorage.getItem('currentProject') || 'Ma Cartographie';
            
            loadProjectSelector();
            loadProcesses();
            loadRiskTypes();
            loadSuggestions();
            loadRisks();
            generateMatrix();
            updateStatistics();
        }

        // ========== GESTION DES PROJETS ==========

        function loadProjectSelector() {
            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            const selector = document.getElementById('projectSelector');
            
            selector.innerHTML = '';
            Object.keys(projects).sort().forEach(projectName => {
                const option = document.createElement('option');
                option.value = projectName;
                option.textContent = projectName;
                if (projectName === currentProject) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        function switchProject() {
            const newProject = document.getElementById('projectSelector').value;
            currentProject = newProject;
            localStorage.setItem('currentProject', newProject);
            
            loadProcesses();
            loadRiskTypes();
            loadSuggestions();
            loadRisks();
            generateMatrix();
            updateStatistics();
            
            showAlert(`Cartographie "${newProject}" charg√©e !`, 'success');
        }

        function showNewProjectDialog() {
            const projectName = prompt('Nom de la nouvelle cartographie :\n(ex: CDG 54, Formation 2025, etc.)');
            
            if (!projectName || projectName.trim() === '') {
                return;
            }

            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            
            if (projects[projectName]) {
                showAlert('Une cartographie avec ce nom existe d√©j√† !', 'danger');
                return;
            }

            projects[projectName] = {
                risks: [],
                processes: [...defaultProcesses],
                riskTypes: [...defaultRiskTypes],
                suggestions: JSON.parse(JSON.stringify(defaultSuggestions))
            };

            localStorage.setItem('projects', JSON.stringify(projects));
            currentProject = projectName;
            localStorage.setItem('currentProject', projectName);

            loadProjectSelector();
            loadProcesses();
            loadRiskTypes();
            loadSuggestions();
            loadRisks();
            generateMatrix();
            updateStatistics();

            showAlert(`Cartographie "${projectName}" cr√©√©e !`, 'success');
        }

        function showRenameProjectDialog() {
            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            const oldName = currentProject;
            
            const newName = prompt(`Renommer la cartographie "${oldName}" :\n\nNouveau nom :`, oldName);
            
            if (!newName || newName.trim() === '' || newName === oldName) {
                return;
            }

            if (projects[newName]) {
                showAlert('Une cartographie avec ce nom existe d√©j√† !', 'danger');
                return;
            }

            projects[newName] = projects[oldName];
            delete projects[oldName];

            localStorage.setItem('projects', JSON.stringify(projects));
            currentProject = newName;
            localStorage.setItem('currentProject', newName);

            loadProjectSelector();
            showAlert(`Cartographie renomm√©e en "${newName}" !`, 'success');
        }

        function duplicateProject() {
            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            const sourceName = currentProject;
            
            const newName = prompt(`Dupliquer la cartographie "${sourceName}" :\n\nNom de la copie :`, `${sourceName} - Copie`);
            
            if (!newName || newName.trim() === '') {
                return;
            }

            if (projects[newName]) {
                showAlert('Une cartographie avec ce nom existe d√©j√† !', 'danger');
                return;
            }

            projects[newName] = JSON.parse(JSON.stringify(projects[sourceName]));

            localStorage.setItem('projects', JSON.stringify(projects));
            currentProject = newName;
            localStorage.setItem('currentProject', newName);

            loadProjectSelector();
            showAlert(`Cartographie dupliqu√©e en "${newName}" !`, 'success');
        }

        function deleteProject() {
            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            const projectName = currentProject;

            if (Object.keys(projects).length === 1) {
                showAlert('Impossible de supprimer la derni√®re cartographie !', 'danger');
                return;
            }

            if (!confirm(`‚ö†Ô∏è Supprimer d√©finitivement la cartographie "${projectName}" ?\n\nCette action est irr√©versible !`)) {
                return;
            }

            delete projects[projectName];
            localStorage.setItem('projects', JSON.stringify(projects));

            currentProject = Object.keys(projects)[0];
            localStorage.setItem('currentProject', currentProject);

            loadProjectSelector();
            loadProcesses();
            loadRiskTypes();
            loadSuggestions();
            loadRisks();
            generateMatrix();
            updateStatistics();

            showAlert(`Cartographie "${projectName}" supprim√©e !`, 'success');
        }

        // ========== FONCTIONS UTILITAIRES ==========

        function getCurrentProjectData() {
            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            return projects[currentProject] || {
                risks: [],
                processes: [...defaultProcesses],
                riskTypes: [...defaultRiskTypes],
                suggestions: JSON.parse(JSON.stringify(defaultSuggestions))
            };
        }

        function saveCurrentProjectData(projectData) {
            const projects = JSON.parse(localStorage.getItem('projects')) || {};
            projects[currentProject] = projectData;
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        function getRisks() {
            return getCurrentProjectData().risks || [];
        }

        function saveRisks(risks) {
            const projectData = getCurrentProjectData();
            projectData.risks = risks;
            saveCurrentProjectData(projectData);
        }

        function getProcesses() {
            return getCurrentProjectData().processes || [...defaultProcesses];
        }

        function saveProcesses(processes) {
            const projectData = getCurrentProjectData();
            projectData.processes = processes;
            saveCurrentProjectData(projectData);
        }

        function getRiskTypes() {
            return getCurrentProjectData().riskTypes || [...defaultRiskTypes];
        }

        function saveRiskTypes(riskTypes) {
            const projectData = getCurrentProjectData();
            projectData.riskTypes = riskTypes;
            saveCurrentProjectData(projectData);
        }

        function getSuggestions() {
            return getCurrentProjectData().suggestions || JSON.parse(JSON.stringify(defaultSuggestions));
        }

        function saveSuggestions(suggestions) {
            const projectData = getCurrentProjectData();
            projectData.suggestions = suggestions;
            saveCurrentProjectData(projectData);
        }

        // Gestion des onglets
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            const tabButtons = document.getElementsByClassName('tab-button');

            for (let content of tabContents) {
                content.classList.remove('active');
            }

            for (let button of tabButtons) {
                button.classList.remove('active');
            }

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'visualisation') {
                generateMatrix();
            } else if (tabName === 'statistiques') {
                updateStatistics();
            } else if (tabName === 'parametres') {
                displayProcessList();
                displayRiskTypesList();
                displayAllSuggestions();
            }
        }

        function loadProcesses() {
            const processes = getProcesses();
            const selects = ['process', 'filterProcess'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = selectId.includes('filter') ? '<option value="">Tous les processus</option>' : '<option value="">-- S√©lectionner --</option>';
                    processes.forEach(process => {
                        const option = document.createElement('option');
                        option.value = process;
                        option.textContent = process;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                }
            });
        }

        function loadRiskTypes() {
            const riskTypes = getRiskTypes();
            const container = document.getElementById('riskTypeContainer');
            
            if (container) {
                container.innerHTML = '';
                riskTypes.forEach(type => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-label';
                    label.innerHTML = `
                        <input type="checkbox" value="${type}"> ${type}
                    `;
                    container.appendChild(label);
                });
            }
        }

        function loadSuggestions() {
            const suggestions = getSuggestions();
            
            const orgSelect = document.getElementById('mitigationOrgSelect');
            const humSelect = document.getElementById('mitigationHumSelect');
            const techSelect = document.getElementById('mitigationTechSelect');

            if (orgSelect) {
                orgSelect.innerHTML = '<option value="">-- Suggestions --</option>';
                suggestions.org.forEach(s => {
                    orgSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            }

            if (humSelect) {
                humSelect.innerHTML = '<option value="">-- Suggestions --</option>';
                suggestions.hum.forEach(s => {
                    humSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            }

            if (techSelect) {
                techSelect.innerHTML = '<option value="">-- Suggestions --</option>';
                suggestions.tech.forEach(s => {
                    techSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            }
        }

        function insertSuggestion(textareaId, value) {
            if (!value) return;
            
            const textarea = document.getElementById(textareaId);
            const currentValue = textarea.value.trim();
            
            if (currentValue) {
                textarea.value = currentValue + '\n' + value;
            } else {
                textarea.value = value;
            }
        }

        function loadRisks() {
            const savedRisks = getRisks();
            const riskTable = document.getElementById('riskTable');
            riskTable.innerHTML = '';
            savedRisks.forEach((risk, index) => addRowToTable(risk, index));
        }

        function addRisk() {
            const process = document.getElementById('process').value;
            const scenario = document.getElementById('scenario').value;
            const riskTypeCheckboxes = document.querySelectorAll('#riskTypeContainer input[type="checkbox"]:checked');
            const riskType = Array.from(riskTypeCheckboxes).map(cb => cb.value).join(', ');
            const probability = parseInt(document.getElementById('probability').value);
            const impact = parseInt(document.getElementById('impact').value);
            const netRisk = parseInt(document.getElementById('netRisk').value);
            const mitigationOrg = document.getElementById('mitigationOrg').value;
            const mitigationHum = document.getElementById('mitigationHum').value;
            const mitigationTech = document.getElementById('mitigationTech').value;
            const actions = document.getElementById('actions').value;

            if (!riskType) {
                showAlert('Veuillez s√©lectionner au moins un type de risque', 'danger');
                return;
            }

            const criticity = probability * impact;
            const updateHistory = editIndex === null ? 
                `Ajout√© le : ${new Date().toLocaleString('fr-FR')}` : 
                `Modifi√© le : ${new Date().toLocaleString('fr-FR')}`;

            const risk = {
                process,
                scenario,
                riskType,
                probability,
                impact,
                criticity,
                netRisk,
                mitigationOrg,
                mitigationHum,
                mitigationTech,
                actions,
                updateHistory
            };

            if (editIndex === null) {
                saveToLocalStorage(risk);
                showAlert('Risque ajout√© avec succ√®s !', 'success');
            } else {
                updateLocalStorage(risk, editIndex);
                showAlert('Risque modifi√© avec succ√®s !', 'success');
            }

            loadRisks();
            resetForm();
            generateMatrix();
            updateStatistics();
        }

        function addRowToTable(risk, index) {
            const riskTable = document.getElementById('riskTable');
            const row = document.createElement('tr');
            const criticityClass = risk.criticity <= 4 ? 'low' : risk.criticity <= 12 ? 'medium' : 'high';

            row.innerHTML = `
                <td>${risk.process || ''}</td>
                <td>${risk.scenario || ''}</td>
                <td>${risk.riskType || ''}</td>
                <td>${risk.probability || ''}</td>
                <td>${risk.impact || ''}</td>
                <td class="${criticityClass}">${risk.criticity || ''}</td>
                <td>${risk.mitigationOrg || ''}</td>
                <td>${risk.mitigationHum || ''}</td>
                <td>${risk.mitigationTech || ''}</td>
                <td>${risk.netRisk || ''}</td>
                <td>${risk.actions || ''}</td>
                <td style="font-size: 11px;">${risk.updateHistory || ''}</td>
                <td>
                    <button onclick="editRisk(${index})" class="btn-warning" style="padding: 5px 10px; margin-bottom: 5px;">‚úèÔ∏è</button>
                    <button onclick="deleteRisk(${index})" class="btn-danger" style="padding: 5px 10px;">üóëÔ∏è</button>
                </td>
            `;
            riskTable.appendChild(row);
        }

        function saveToLocalStorage(risk) {
            const savedRisks = getRisks();
            savedRisks.push(risk);
            saveRisks(savedRisks);
        }

        function updateLocalStorage(risk, index) {
            const savedRisks = getRisks();
            savedRisks[index] = risk;
            saveRisks(savedRisks);
        }

        function editRisk(index) {
            const savedRisks = getRisks();
            const risk = savedRisks[index];

            document.getElementById('tableau').classList.remove('active');
            document.getElementById('ajout').classList.add('active');
            
            const tabButtons = document.getElementsByClassName('tab-button');
            tabButtons[0].classList.remove('active');
            tabButtons[1].classList.add('active');

            document.getElementById('process').value = risk.process;
            document.getElementById('scenario').value = risk.scenario;
            
            const riskTypeCheckboxes = document.querySelectorAll('#riskTypeContainer input[type="checkbox"]');
            riskTypeCheckboxes.forEach(cb => {
                cb.checked = risk.riskType.includes(cb.value);
            });

            document.getElementById('probability').value = risk.probability;
            document.getElementById('impact').value = risk.impact;
            document.getElementById('netRisk').value = risk.netRisk;
            document.getElementById('mitigationOrg').value = risk.mitigationOrg;
            document.getElementById('mitigationHum').value = risk.mitigationHum;
            document.getElementById('mitigationTech').value = risk.mitigationTech;
            document.getElementById('actions').value = risk.actions;

            editIndex = index;

            document.getElementById('riskForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteRisk(index) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce risque ?')) {
                const savedRisks = getRisks();
                savedRisks.splice(index, 1);
                saveRisks(savedRisks);
                loadRisks();
                generateMatrix();
                updateStatistics();
                showAlert('Risque supprim√©', 'success');
            }
        }

        function resetForm() {
            document.getElementById('riskForm').reset();
            editIndex = null;
            const checkboxes = document.querySelectorAll('#riskTypeContainer input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }

        function filterRisks() {
            const filterProcess = document.getElementById('filterProcess').value;
            const filterCriticity = document.getElementById('filterCriticity').value;
            const searchTerm = document.getElementById('searchRisk').value.toLowerCase();

            const savedRisks = getRisks();
            const riskTable = document.getElementById('riskTable');
            riskTable.innerHTML = '';

            savedRisks.forEach((risk, index) => {
                let show = true;

                if (filterProcess && risk.process !== filterProcess) show = false;
                
                if (filterCriticity) {
                    if (filterCriticity === 'low' && risk.criticity > 4) show = false;
                    if (filterCriticity === 'medium' && (risk.criticity <= 4 || risk.criticity >= 13)) show = false;
                    if (filterCriticity === 'high' && risk.criticity < 15) show = false;
                }

                if (searchTerm && !risk.scenario.toLowerCase().includes(searchTerm)) show = false;

                if (show) {
                    addRowToTable(risk, index);
                }
            });
        }

        function sortTable(column) {
            const savedRisks = getRisks();
            
            if (!sortOrder[column]) sortOrder[column] = 1;
            
            savedRisks.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return -1 * sortOrder[column];
                if (valA > valB) return 1 * sortOrder[column];
                return 0;
            });

            saveRisks(savedRisks);
            loadRisks();
            sortOrder[column] *= -1;
        }

        function generateMatrix() {
            const matrix = document.getElementById('riskMatrix');
            matrix.innerHTML = '';

            const emptyCell = document.createElement('div');
            emptyCell.className = 'matrix-label';
            matrix.appendChild(emptyCell);

            for (let i = 1; i <= 5; i++) {
                const label = document.createElement('div');
                label.className = 'matrix-label';
                label.textContent = `P${i}`;
                label.title = `Probabilit√© ${i}`;
                matrix.appendChild(label);
            }

            const savedRisks = getRisks();
            const riskCounts = {};
            const risksByCell = {};

            savedRisks.forEach(risk => {
                const key = `${risk.impact}-${risk.probability}`;
                riskCounts[key] = (riskCounts[key] || 0) + 1;
                if (!risksByCell[key]) risksByCell[key] = [];
                risksByCell[key].push(risk);
            });

            for (let impact = 5; impact >= 1; impact--) {
                const label = document.createElement('div');
                label.className = 'matrix-label';
                label.textContent = `I${impact}`;
                label.title = `Impact ${impact}`;
                matrix.appendChild(label);

                for (let prob = 1; prob <= 5; prob++) {
                    const criticity = impact * prob;
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    
                    if (criticity <= 4) {
                        cell.classList.add('risk-low');
                    } else if (criticity <= 12) {
                        cell.classList.add('risk-medium');
                    } else {
                        cell.classList.add('risk-high');
                    }

                    cell.textContent = criticity;

                    const key = `${impact}-${prob}`;
                    if (riskCounts[key]) {
                        const countBadge = document.createElement('span');
                        countBadge.className = 'risk-count';
                        countBadge.textContent = riskCounts[key];
                        cell.appendChild(countBadge);
                    }

                    cell.onclick = () => showMatrixRisks(impact, prob, risksByCell[key] || []);
                    matrix.appendChild(cell);
                }
            }
        }

        function showMatrixRisks(impact, prob, risks) {
            const detailsDiv = document.getElementById('matrixRisksList');
            
            if (risks.length === 0) {
                detailsDiv.innerHTML = `
                    <div class="alert alert-info show">
                        Aucun risque avec Impact ${impact} et Probabilit√© ${prob}
                    </div>
                `;
                return;
            }

            let html = `<h4>Risques avec Impact ${impact} et Probabilit√© ${prob} (Criticit√©: ${impact * prob})</h4>`;
            
            risks.forEach(risk => {
                const criticityClass = risk.criticity <= 4 ? 'low' : risk.criticity <= 12 ? 'medium' : 'high';
                html += `
                    <div style="background: white; border: 1px solid #dee2e6; border-left: 4px solid ${criticityClass === 'low' ? '#28a745' : criticityClass === 'medium' ? '#ffc107' : '#dc3545'}; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #007bff; font-size: 16px; margin-bottom: 5px;">${risk.process}</div>
                        <small style="color: #6c757d;">${risk.riskType}</small>
                        <div style="color: #6c757d; font-size: 13px; margin-top: 10px;">
                            ${risk.scenario}
                        </div>
                    </div>
                `;
            });

            detailsDiv.innerHTML = html;
        }

        function updateStatistics() {
            const savedRisks = getRisks();
            const statsContainer = document.getElementById('statsContainer');

            const totalRisks = savedRisks.length;
            const lowRisks = savedRisks.filter(r => r.criticity <= 4).length;
            const mediumRisks = savedRisks.filter(r => r.criticity > 4 && r.criticity <= 12).length;
            const highRisks = savedRisks.filter(r => r.criticity >= 15).length;

            const avgCriticity = totalRisks > 0 ? 
                (savedRisks.reduce((sum, r) => sum + r.criticity, 0) / totalRisks).toFixed(1) : 0;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Risques</div>
                    <div class="stat-number">${totalRisks}</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #28a745;">
                    <div class="stat-label">Risques Faibles</div>
                    <div class="stat-number" style="color: #28a745;">${lowRisks}</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ffc107;">
                    <div class="stat-label">Risques Moyens</div>
                    <div class="stat-number" style="color: #ffc107;">${mediumRisks}</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #dc3545;">
                    <div class="stat-label">Risques √âlev√©s</div>
                    <div class="stat-number" style="color: #dc3545;">${highRisks}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Criticit√© Moyenne</div>
                    <div class="stat-number">${avgCriticity}</div>
                </div>
            `;

            const processCounts = {};
            savedRisks.forEach(r => {
                processCounts[r.process] = (processCounts[r.process] || 0) + 1;
            });

            let processHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
            Object.entries(processCounts).sort((a, b) => b[1] - a[1]).forEach(([process, count]) => {
                const percentage = ((count / totalRisks) * 100).toFixed(1);
                processHtml += `
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <strong>${process}</strong>
                        <div style="margin-top: 10px;">
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: #007bff; width: ${percentage}%; height: 100%; transition: width 0.3s;"></div>
                            </div>
                            <small style="color: #6c757d;">${count} risques (${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            processHtml += '</div>';
            document.getElementById('processStats').innerHTML = processHtml;

            const typeCounts = {};
            savedRisks.forEach(r => {
                r.riskType.split(', ').forEach(type => {
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
            });

            let typeHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
            Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                const percentage = ((count / totalRisks) * 100).toFixed(1);
                typeHtml += `
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <strong>${type}</strong>
                        <div style="margin-top: 10px;">
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: #dc3545; width: ${percentage}%; height: 100%; transition: width 0.3s;"></div>
                            </div>
                            <small style="color: #6c757d;">${count} occurrences (${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            typeHtml += '</div>';
            document.getElementById('typeStats').innerHTML = typeHtml;
        }

        function addProcess() {
            const newProcess = document.getElementById('newProcess').value.trim();
            if (!newProcess) {
                showAlert('Veuillez entrer un nom de processus', 'danger');
                return;
            }

            const processes = getProcesses();
            if (processes.includes(newProcess)) {
                showAlert('Ce processus existe d√©j√†', 'danger');
                return;
            }

            processes.push(newProcess);
            saveProcesses(processes);
            document.getElementById('newProcess').value = '';
            loadProcesses();
            displayProcessList();
            showAlert('Processus ajout√© !', 'success');
        }

        function displayProcessList() {
            const processes = getProcesses();
            const container = document.getElementById('processList');
            
            container.innerHTML = '';
            processes.forEach((process, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span>${process}</span>
                    <button onclick="deleteProcess(${index})" class="btn-danger" style="padding: 5px 10px;">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        function deleteProcess(index) {
            if (confirm('Supprimer ce processus ? (Les risques associ√©s ne seront pas supprim√©s)')) {
                const processes = getProcesses();
                processes.splice(index, 1);
                saveProcesses(processes);
                loadProcesses();
                displayProcessList();
                showAlert('Processus supprim√©', 'success');
            }
        }

        function addRiskType() {
            const newRiskType = document.getElementById('newRiskType').value.trim();
            if (!newRiskType) {
                showAlert('Veuillez entrer un type de risque', 'danger');
                return;
            }

            const riskTypes = getRiskTypes();
            if (riskTypes.includes(newRiskType)) {
                showAlert('Ce type de risque existe d√©j√†', 'danger');
                return;
            }

            riskTypes.push(newRiskType);
            saveRiskTypes(riskTypes);
            document.getElementById('newRiskType').value = '';
            loadRiskTypes();
            displayRiskTypesList();
            showAlert('Type de risque ajout√© !', 'success');
        }

        function displayRiskTypesList() {
            const riskTypes = getRiskTypes();
            const container = document.getElementById('riskTypesList');
            
            container.innerHTML = '';
            riskTypes.forEach((type, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span>${type}</span>
                    <button onclick="deleteRiskType(${index})" class="btn-danger" style="padding: 5px 10px;">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        function deleteRiskType(index) {
            if (confirm('Supprimer ce type de risque ?')) {
                const riskTypes = getRiskTypes();
                riskTypes.splice(index, 1);
                saveRiskTypes(riskTypes);
                loadRiskTypes();
                displayRiskTypesList();
                showAlert('Type de risque supprim√©', 'success');
            }
        }

        function addSuggestion(type) {
            const inputId = `new${type.charAt(0).toUpperCase() + type.slice(1)}Suggestion`;
            const newSuggestion = document.getElementById(inputId).value.trim();
            
            if (!newSuggestion) {
                showAlert('Veuillez entrer une suggestion', 'danger');
                return;
            }

            const suggestions = getSuggestions();
            
            if (suggestions[type].includes(newSuggestion)) {
                showAlert('Cette suggestion existe d√©j√†', 'danger');
                return;
            }

            suggestions[type].push(newSuggestion);
            saveSuggestions(suggestions);
            document.getElementById(inputId).value = '';
            loadSuggestions();
            displayAllSuggestions();
            showAlert('Suggestion ajout√©e !', 'success');
        }

        function displayAllSuggestions() {
            const suggestions = getSuggestions();
            
            displaySuggestionList('org', suggestions.org);
            displaySuggestionList('hum', suggestions.hum);
            displaySuggestionList('tech', suggestions.tech);
        }

        function displaySuggestionList(type, items) {
            const container = document.getElementById(`${type}SuggestionsList`);
            
            container.innerHTML = '';
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.fontSize = '13px';
                div.innerHTML = `
                    <span>${item}</span>
                    <button onclick="deleteSuggestion('${type}', ${index})" class="btn-danger" style="padding: 3px 8px; font-size: 12px;">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        function deleteSuggestion(type, index) {
            if (confirm('Supprimer cette suggestion ?')) {
                const suggestions = getSuggestions();
                suggestions[type].splice(index, 1);
                saveSuggestions(suggestions);
                loadSuggestions();
                displayAllSuggestions();
                showAlert('Suggestion supprim√©e', 'success');
            }
        }

        function clearAllRisks() {
            if (confirm(`‚ö†Ô∏è ATTENTION : Supprimer TOUS les risques de la cartographie "${currentProject}" ? Cette action est irr√©versible !`)) {
                const risks = [];
                saveRisks(risks);
                loadRisks();
                generateMatrix();
                updateStatistics();
                showAlert('Tous les risques ont √©t√© supprim√©s', 'success');
            }
        }

        function resetToDefaults() {
            if (confirm(`‚ö†Ô∏è ATTENTION : R√©initialiser la cartographie "${currentProject}" aux valeurs par d√©faut ? Les risques seront supprim√©s ! Cette action est irr√©versible !`)) {
                const projectData = {
                    risks: [],
                    processes: [...defaultProcesses],
                    riskTypes: [...defaultRiskTypes],
                    suggestions: JSON.parse(JSON.stringify(defaultSuggestions))
                };
                saveCurrentProjectData(projectData);
                
                loadProcesses();
                loadRiskTypes();
                loadSuggestions();
                loadRisks();
                displayProcessList();
                displayRiskTypesList();
                displayAllSuggestions();
                generateMatrix();
                updateStatistics();
                showAlert('Cartographie r√©initialis√©e aux valeurs par d√©faut', 'success');
            }
        }

        // Export/Import
        function exportToJSON() {
            const data = {
                projectName: currentProject,
                projectData: getCurrentProjectData(),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const safeName = currentProject.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.download = `carto_${safeName}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert(`Cartographie "${currentProject}" export√©e !`, 'success');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    let projectName = data.projectName || 'Cartographie Import√©e';
                    const projects = JSON.parse(localStorage.getItem('projects')) || {};
                    
                    let counter = 1;
                    let finalName = projectName;
                    while (projects[finalName]) {
                        finalName = `${projectName} (${counter})`;
                        counter++;
                    }
                    
                    if (confirm(`‚ö†Ô∏è Importer cette cartographie sous le nom "${finalName}" ?`)) {
                        projects[finalName] = data.projectData || {
                            risks: data.risks || [],
                            processes: data.processes || [...defaultProcesses],
                            riskTypes: data.riskTypes || [...defaultRiskTypes],
                            suggestions: data.suggestions || JSON.parse(JSON.stringify(defaultSuggestions))
                        };
                        
                        localStorage.setItem('projects', JSON.stringify(projects));
                        currentProject = finalName;
                        localStorage.setItem('currentProject', finalName);
                        
                        loadProjectSelector();
                        loadProcesses();
                        loadRiskTypes();
                        loadSuggestions();
                        loadRisks();
                        generateMatrix();
                        updateStatistics();
                        showAlert(`Cartographie "${finalName}" import√©e avec succ√®s !`, 'success');
                    }
                } catch (error) {
                    showAlert('Erreur lors de l\'importation : fichier invalide', 'danger');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportToPDF() {
            window.print();
        }

        function exportToDoc() {
            const content = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="UTF-8"><title>Cartographie des Risques</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 10px; }
                    .low { background-color: #d4edda; }
                    .medium { background-color: #fff3cd; }
                    .high { background-color: #f8d7da; }
                    @page { size: landscape; }
                </style>
                </head>
                <body>
                    <h1>Cartographie des Risques d'Atteintes √† la Probit√©</h1>
                    ${document.querySelector('#riskTable').parentElement.outerHTML}
                    <p style="text-align: right; font-size: 10px; margin-top: 20px;">Outil cr√©√© et d√©velopp√© par Louis MATHEVET-BIDINI, Pr√©sident de l'AP2DFP</p>
                </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cartographie_risques_${new Date().toISOString().split('T')[0]}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('Document Word t√©l√©charg√© !', 'success');
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
